<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=yes">
    <title>Dashboard - LuxeCompanions</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600&family=Montserrat:wght@300;400;500&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="js/cache.js"></script>
    <script>
        window.toggleMobileMenu = function() {
            var navbar = document.getElementById('navbar');
            if (navbar) navbar.classList.toggle('active');
            return false;
        };
    </script>
</head>
<body>
    <!-- Navigation (same as index) -->
    <nav class="navbar" id="navbar">
        <div class="nav-container">
            <div class="logo">
                <i class="fas fa-gem"></i>
                <span>LuxeCompanions</span>
            </div>
            <div class="menu-toggle" id="mobileMenu" onclick="toggleMobileMenu(); event.stopPropagation();">
                <i class="fas fa-bars"></i>
            </div>
            <div class="nav-links" id="navLinks"></div>
        </div>
    </nav>

    <!-- Dashboard Main Content -->
    <main class="dashboard-main">
        <div class="dashboard-container">
            <div class="dashboard-header">
                <div class="welcome-section">
                    <h1>Welcome back, <span id="userName">Loading...</span>!</h1>
                    <p class="member-since">Member since <span id="memberSince">â€”</span></p>
                </div>
                <div class="header-actions">
                    <a href="post-ad.html" class="btn-primary" id="createPostBtn">
                        <i class="fas fa-plus-circle"></i> Create New Post
                    </a>
                </div>
            </div>

            <!-- Subscription Status Card -->
            <div class="dashboard-grid">
                <div class="dashboard-card subscription-card">
                    <div class="card-header">
                        <i class="fas fa-crown"></i>
                        <h2>Subscription</h2>
                    </div>
                    <div id="subscriptionDetails" class="subscription-details">
                        <div class="loading-spinner"></div>
                    </div>
                    <div id="subscriptionAction" class="card-action"></div>
                </div>

                <!-- Quick Stats Card -->
                <div class="dashboard-card stats-card">
                    <div class="card-header">
                        <i class="fas fa-chart-line"></i>
                        <h2>Your Stats</h2>
                    </div>
                    <div class="stats-grid">
                        <div class="stat-item">
                            <span class="stat-value" id="postCount">0</span>
                            <span class="stat-label">Active Posts</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="totalViews">0</span>
                            <span class="stat-label">Total Views</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-value" id="profileViews">0</span>
                            <span class="stat-label">Profile Views</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- User Posts Section -->
            <section class="user-posts-section">
                <div class="section-header">
                    <h2><i class="fas fa-list"></i> Your Active Listings</h2>
                    <p class="section-subtitle">Manage and track your posted ads</p>
                </div>
                
                <div id="postsContainer" class="posts-grid">
                    <div class="loading">Loading your posts...</div>
                </div>

                <div id="emptyPostsState" class="empty-state" style="display: none;">
                    <i class="fas fa-camera-retro"></i>
                    <h3>You haven't posted any ads yet</h3>
                    <p>Create your first listing and start connecting with clients today!</p>
                    <a href="post-ad.html" class="btn-primary">
                        <i class="fas fa-plus-circle"></i> Create Your First Post
                    </a>
                </div>
            </section>
        </div>
    </main>

    <!-- Footer -->
    <footer>...</footer>

    <script src="js/auth.js"></script>
    <script>
        // DASHBOARD CONTROLLER WITH CACHING
        document.addEventListener('DOMContentLoaded', async function() {
            if (!window.supabase) {
                window.location.href = 'index.html';
                return;
            }

            const { data: { user }, error } = await window.supabase.auth.getUser();
            if (error || !user) {
                window.location.href = 'index.html';
                return;
            }

            // Load user profile (try cache first)
            await loadUserProfileWithCache(user.id);
            
            // Load user posts (try cache first)
            await loadUserPostsWithCache(user.id);
            
            const createdDate = new Date(user.created_at);
            document.getElementById('memberSince').textContent = createdDate.toLocaleDateString('en-US', { 
                year: 'numeric', month: 'long', day: 'numeric' 
            });
        });

        async function loadUserProfileWithCache(userId) {
            // Try cache
            let profile = getUserProfile();
            if (profile && profile.id === userId) {
                renderSubscriptionCard(profile);
                document.getElementById('userName').textContent = profile.username || 'User';
                // Refresh in background
                refreshUserProfile(userId);
            } else {
                // Load from DB
                await refreshUserProfile(userId);
            }
        }

        async function refreshUserProfile(userId) {
            try {
                const { data: profile, error } = await window.supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', userId)
                    .single();

                if (error) throw error;
                
                setUserProfile(profile);
                renderSubscriptionCard(profile);
                document.getElementById('userName').textContent = profile.username || 'User';
            } catch (err) {
                console.error('Profile load error:', err);
            }
        }

        function renderSubscriptionCard(profile) {
            const detailsEl = document.getElementById('subscriptionDetails');
            const actionEl = document.getElementById('subscriptionAction');
            
            const now = new Date();
            const expiresAt = profile.subscription_expires_at ? new Date(profile.subscription_expires_at) : null;
            const hasValidSub = profile.subscription_type !== 'none' && expiresAt && expiresAt > now;

            if (hasValidSub) {
                const daysLeft = Math.ceil((expiresAt - now) / (1000 * 60 * 60 * 24));
                detailsEl.innerHTML = `
                    <div class="subscription-active">
                        <span class="badge ${profile.subscription_type}">${profile.subscription_type.toUpperCase()}</span>
                        <p class="expiry">Valid until: ${expiresAt.toLocaleDateString('en-US', { 
                            year: 'numeric', month: 'long', day: 'numeric' 
                        })} (${daysLeft} days left)</p>
                    </div>
                `;
                actionEl.innerHTML = `
                    <a href="subscription.html" class="btn-secondary">
                        <i class="fas fa-arrow-up"></i> Upgrade Plan
                    </a>
                `;
            } else {
                detailsEl.innerHTML = `
                    <div class="subscription-inactive">
                        <p class="no-subscription">You don't have an active subscription</p>
                        <p class="sub-required">A subscription is required to post ads.</p>
                    </div>
                `;
                actionEl.innerHTML = `
                    <a href="subscription.html" class="btn-primary">
                        <i class="fas fa-crown"></i> Subscribe Now
                    </a>
                `;
            }
        }

        async function loadUserPostsWithCache(userId) {
            const cachedPosts = getUserPosts();
            if (cachedPosts && cachedPosts.length > 0) {
                displayUserPosts(cachedPosts);
                // Refresh in background
                refreshUserPosts(userId);
            } else {
                await refreshUserPosts(userId);
            }
        }

        async function refreshUserPosts(userId) {
            try {
                const { data: posts, error } = await window.supabase
                    .from('posts')
                    .select('*')
                    .eq('user_id', userId)
                    .eq('status', 'active')
                    .order('created_at', { ascending: false });

                if (error) throw error;
                
                setUserPosts(posts);
                displayUserPosts(posts);
            } catch (err) {
                console.error('Posts load error:', err);
            }
        }

        function displayUserPosts(posts) {
            document.getElementById('postCount').textContent = posts?.length || 0;
            document.getElementById('totalViews').textContent = '0'; // placeholder
            document.getElementById('profileViews').textContent = '0';

            const postsContainer = document.getElementById('postsContainer');
            const emptyState = document.getElementById('emptyPostsState');

            if (!posts || posts.length === 0) {
                postsContainer.style.display = 'none';
                emptyState.style.display = 'block';
            } else {
                emptyState.style.display = 'none';
                postsContainer.style.display = 'grid';
                postsContainer.innerHTML = '';

                posts.forEach(post => {
                    postsContainer.appendChild(createPostCard(post));
                });
            }
        }

        function createPostCard(post) {
            const card = document.createElement('div');
            card.className = `listing-card ${post.is_vip ? 'vip-card' : ''}`;
            card.dataset.postId = post.id;
            
            const created = new Date(post.created_at);
            const dateStr = created.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });

            card.innerHTML = `
                ${post.is_vip ? '<div class="vip-badge"><i class="fas fa-crown"></i> VIP</div>' : ''}
                <img src="${post.images && post.images[0] ? post.images[0] : 'images/default-avatar.jpg'}" 
                     alt="${escapeHtml(post.title || 'Listing')}" 
                     class="listing-image"
                     onerror="this.src='images/default-avatar.jpg'">
                <div class="listing-content">
                    <h3>${escapeHtml(post.title || 'Untitled')}</h3>
                    <p class="listing-description">${escapeHtml((post.description || '').substring(0, 80))}...</p>
                    <div class="listing-meta">
                        <span><i class="fas fa-calendar"></i> ${dateStr}</span>
                        <span><i class="fas fa-eye"></i> ${post.views || 0} views</span>
                    </div>
                    <div class="post-actions">
                        <button onclick="editPost('${post.id}')" class="btn-edit">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button onclick="deletePost('${post.id}')" class="btn-delete">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            `;
            return card;
        }

        window.editPost = function(postId) {
            window.location.href = `edit-post.html?id=${postId}`;
        };

        window.deletePost = async function(postId) {
            if (!confirm('Are you sure you want to delete this post?')) return;
            try {
                const { error } = await window.supabase
                    .from('posts')
                    .update({ status: 'deleted' })
                    .eq('id', postId);
                if (error) throw error;
                
                // Remove from UI and update cache
                const card = document.querySelector(`.listing-card[data-post-id="${postId}"]`);
                if (card) card.remove();
                
                // Update post count
                const countEl = document.getElementById('postCount');
                const current = parseInt(countEl.textContent) || 0;
                countEl.textContent = Math.max(0, current - 1);
                
                // Update cache: remove the post from cached posts
                const cachedPosts = getUserPosts();
                if (cachedPosts) {
                    const updated = cachedPosts.filter(p => p.id !== postId);
                    setUserPosts(updated);
                }
                
                // If no posts left, show empty state
                const postsContainer = document.getElementById('postsContainer');
                if (postsContainer.children.length === 0) {
                    postsContainer.style.display = 'none';
                    document.getElementById('emptyPostsState').style.display = 'block';
                }
            } catch (err) {
                alert('Delete failed: ' + err.message);
            }
        };

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>

    <!-- Mobile menu close handler -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            var navbar = document.getElementById('navbar');
            document.addEventListener('click', function(e) {
                if (navbar.classList.contains('active') && !navbar.contains(e.target)) navbar.classList.remove('active');
            });
            var navLinks = document.getElementById('navLinks');
            if (navLinks) {
                navLinks.addEventListener('click', function(e) {
                    if (e.target.tagName === 'A' || e.target.tagName === 'BUTTON') navbar.classList.remove('active');
                });
            }
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) navbar.classList.remove('active');
            });
        });
    </script>
</body>
</html>
